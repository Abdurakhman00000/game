var jw_playlist_album=[];var jw_albums=[];var jw_closed_lists=[];var albumPlaying=null;var maxRating=5;var default_album_template="";var album_template_suffix=sessionStorage.getItem('album_template_suffix');if(album_template_suffix==null)album_template_suffix=default_album_template;if(typeof player_created=='undefined')var player_created=false;function render_items(data,container_id){if(typeof container_id==='undefined')container_id=undefined;var there_are_songs=false;var is_module=parseInt(jQuery(container_id).attr('is-module'));jQuery.each(data,function(index,value){if(value&&!displayplayer)value.isplayable=0;if(value.item_type=="song")value.lastPlaylists=lastPlaylists;render_item(value,container_id);if((value.item_type=="song"||value.item_type=="song-edit")&&value.isplayable&&!is_module)there_are_songs=true;});if(container_id!==undefined){var is_closed_list=parseInt(jQuery(container_id).attr('is-closed-list'));if(is_closed_list){var container=container_id.substring(1);store_playlist_playlist(container,data);}}
if(there_are_songs&&!player_created){if(typeof create_player=='function')create_player();new_songs_in_playlist=false;}
jQuery('[data-toggle="tooltip"]').tooltip();}
function render_item(data,container_id){if(typeof container_id==='undefined')container_id="#"+data.item_type+"_search_results";var spanclass=jQuery(container_id).attr('data-spanclass');if(spanclass=="")spanclass=3;var is_module=parseInt(jQuery(container_id).attr('is-module'));var suffix="";if(data.item_type=="album"){if(is_module)album_template_suffix=jQuery(container_id).attr('data-template');switch(album_template_suffix){case "detailed":suffix="-detailed";spanclass=jQuery(container_id).attr('data-spanclass-detailed');if(spanclass=="")spanclass=12;break;default:suffix="";break;}
data.spanclass=spanclass;}
else if(data.item_type=="artist"){data.spanclass=spanclass;}
var source=jQuery("#"+data.item_type+"-template"+suffix).html();var template=Handlebars.compile(source);var context=data;var html=template(context);jQuery(container_id).append(html);if((data.item_type=="song"||data.item_type=="song-edit")&&data.isplayable&&!is_module){if(typeof jw_playlist_search!=='undefined')jw_playlist_search.push(playlist_object(data));new_songs_in_playlist=true;}}
function get_id_from_index(index){var theobject=jQuery(".song-item[data-isplayable]")[index];var theid=jQuery(theobject).attr('data-id');return theid;}
function play_album(album_tag,ev){ev.preventDefault();if(album_tag.hasClass('readyToPlay')){var this_album_id=parseInt(album_tag.attr('data-id'));if(albumPlaying!=this_album_id){currentItem=-1;notifyAlbum=true;get_album_songs(this_album_id);if(albumPlaying!==null&&albumPlaying!==this_album_id)dishighlight_album(albumPlaying);albumPlaying=this_album_id;}
else{currentItem=-1;notifyAlbum=true;play_song_position(0);}}else if(album_tag.hasClass('playing')){jwplayer().pause();}else{jwplayer().play();}}
function dishighlight_album(album_tag){jQuery('.playPauseAlbumBtn[data-id='+album_tag+']').removeClass('playing').removeClass('paused').addClass('readyToPlay');}
function get_album_songs(album_id){var url=base+extrabase+"/index.php?option=com_muscol&task=get_album_songs&id="+album_id;jQuery.ajax({url:url,dataType:'json',success:function(result){if(result.length){store_album_playlist(result);fill_album_playlist(result);play_album_playlist();}}});}
function store_album_playlist(data){if(!(data[0].album_id in jw_albums)){jw_albums[data[0].album_id]=data;}}
function store_playlist_playlist(key,data){if(!(jw_closed_lists[key])){jw_closed_lists[key]=data;}else{for(var i=0;i<data.length;++i){jw_closed_lists[key].push(data[i]);}}}
function fill_album_playlist(data){jw_playlist_album=[];jQuery.each(data,function(index,value){input_song_to_album_playlist(value);});}
function input_song_to_album_playlist(data){if(data.item_type=="song"){jw_playlist_album.push(playlist_object(data));}}
function play_album_playlist(){if(!player_created){if(typeof create_player=='function')create_player(jw_playlist_album);jwplayer().on('ready',function(){jwplayer().play();});}else{jwplayer().load(jw_playlist_album);jwplayer().play();}}
function reset_playlist(){jw_playlist_search=[];}
function playlist_object(song){var playlist_object={file:song.file,title:song.name,description:song.artist_name,image:base+extrabase+"/"+song.thumbnail_src};return playlist_object;}
function play_song(song_tag){var song_container=song_tag.closest('tbody');var song_container_id=song_container.attr('id');var album_id=parseInt(song_container.attr('album-id'));var playing_inside_album=parseInt(song_container.attr('is-album'));var is_closed_list=parseInt(song_container.attr('is-closed-list'));if(albumPlaying&&!playing_inside_album&&!is_closed_list){new_songs_in_playlist=true;dishighlight_album(albumPlaying);albumPlaying=null;}
if(albumPlaying!==null&&albumPlaying!==album_id)dishighlight_album(albumPlaying);var index_in_playlist=jQuery("#"+song_container_id+" .song-item[data-isplayable] .playPauseSongBtn").index(song_tag);var state=null;var indexPlaying=null;if(playing_inside_album){if(albumPlaying!=album_id){currentItem=-1;if(index_in_playlist===0)notifyFirstSong=true;fill_album_playlist(jw_albums[album_id]);if(!player_created){if(typeof create_player=='function')create_player(jw_playlist_album);jwplayer().on('ready',function(){play_song_position(index_in_playlist);});}
else{jwplayer().load(jw_playlist_album);play_song_position(index_in_playlist);}
albumPlaying=album_id;}else{state=jwplayer().getState();indexPlaying=jwplayer().getPlaylistIndex();if(index_in_playlist===0&&indexPlaying===0&&state==='playing'){jwplayer().pause();}else if(index_in_playlist===0&&indexPlaying===0&&state==='paused'){jwplayer().play();}else{if(index_in_playlist===0)notifyFirstSong=true;play_song_position(index_in_playlist);}}
new_songs_in_playlist=false;}else if(is_closed_list){var key=song_container.attr('id');if(albumPlaying!==key){currentItem=-1;if(index_in_playlist===0)notifyFirstSong=true;fill_album_playlist(jw_closed_lists[key]);if(!player_created){if(typeof create_player=='function')create_player(jw_playlist_album);jwplayer().on('ready',function(){play_song_position(index_in_playlist);});}
else{jwplayer().load(jw_playlist_album);play_song_position(index_in_playlist);}
albumPlaying=key;}else{state=jwplayer().getState();indexPlaying=jwplayer().getPlaylistIndex();if(index_in_playlist===0&&indexPlaying===0&&state==='playing'){jwplayer().pause();}else if(index_in_playlist===0&&indexPlaying===0&&state==='paused'){jwplayer().play();}else play_song_position(index_in_playlist);}
new_songs_in_playlist=false;}
if(new_songs_in_playlist){load_playlist();}
if(!is_closed_list&&!playing_inside_album){state=jwplayer().getState();indexPlaying=jwplayer().getPlaylistIndex();if(index_in_playlist===0&&indexPlaying===0&&state==='playing'){jwplayer().pause();}else if(index_in_playlist===0&&indexPlaying===0&&state==='paused'){jwplayer().play();}else{if(index_in_playlist===0)notifyFirstSong=true;play_song_position(index_in_playlist);}}
var song_id=song_tag.attr('data-id');}
function load_playlist(){currentItem=-1;jwplayer().load(jw_playlist_search);new_songs_in_playlist=false;}
function notifyMessages(notifications){jQuery.each(notifications,function(index,notification){var type=notification.type;if(type==='message')type='success';noty({text:notification.message,layout:'bottomLeft',type:type,timeout:3000,theme:'material',animation:{open:{height:'toggle'},close:{height:'toggle'},easing:'swing',speed:200}});});}
function change_albums_layout(layout){if(!isloading_album){album_template_suffix=layout;sessionStorage.setItem('album_template_suffix',album_template_suffix);reset_album_list();load_more_items('album',false);}}
function show_album_songs(album_id,ev){ev.preventDefault();var thebutton=jQuery(".album-card[data-id="+album_id+"] .load-songs-button");var isopen=jQuery("#songs-album-container-"+album_id).hasClass('songs-album-container-open');if(isopen){jQuery("#songs-album-container-"+album_id).removeClass('songs-album-container-open');jQuery(".album-card[data-id="+album_id+"] .main-card").removeClass('main-card-open');thebutton.html(showSongsText);}
else{if(jQuery('#songs-album-'+album_id).is(':empty')){var url=base+extrabase+"/index.php?option=com_muscol&task=get_album_songs&id="+album_id;thebutton.html(hideSongsText).button('loading');jQuery.ajax({url:url,dataType:'json',success:function(result){if(result.length){render_songs_small(result);store_album_playlist(result);jQuery("#songs-album-container-"+album_id).addClass('songs-album-container-open');jQuery(".album-card[data-id="+album_id+"] .main-card").addClass('main-card-open');thebutton.html(hideSongsText).button('reset');fill_album_playlist(result);}}});}
else{jQuery("#songs-album-container-"+album_id).addClass('songs-album-container-open');thebutton.html(hideSongsText);}}}
function render_songs_small(data){var there_are_songs=false;jQuery.each(data,function(index,value){if(value&&!displayplayer)value.isplayable=0;if(value.item_type=="song")value.lastPlaylists=lastPlaylists;render_song_small(value);});jQuery('[data-toggle="tooltip"]').tooltip();}
function render_song_small(data){var source=jQuery("#song-small-template").html();var template=Handlebars.compile(source);var context=data;var html=template(context);jQuery("#songs-album-"+data.album_id).append(html);}
jQuery(document).ready(function(){if(typeof(ratings)!=='undefined'){buildUsersStars(ratings.average_rating,'.usersStars');buildAdminStars(ratings.admin_rating,'.adminStars');}});function buildUsersStars(currentRating,containerSelector){var usersStars=document.querySelector(containerSelector);if(usersStars){var usersRatingCallback=function(rating){rate(rating,usersRating);};var blocked=jQuery(containerSelector).hasClass('blocked');var usersRating=rating(usersStars,currentRating,maxRating,usersRatingCallback,blocked);}}
function buildAdminStars(currentRating,containerSelector){var adminStars=document.querySelector(containerSelector);if(adminStars){var adminRatingCallback=function(rating){};var adminRating=rating(adminStars,currentRating,maxRating,adminRatingCallback,true);}}
function rate(rating,usersRating){var url=base+extrabase+'/index.php?option=com_muscol&task=rate&album_id='+ratings.id+'&rating='+rating;if(ratings.type==='album')url+='&type=album';else url+='&type=song';jQuery.ajax({url:url,dataType:'json',success:function(result){var idRated=result.id;usersRating.setRating(Math.round(result.rating),false);notifyMessages(result.notifications);}});}
function seeOtherPlaylistsToAddSong(id){jQuery('#otherPlaylistsModal').modal();jQuery('#playlistsResultContainer').empty();jQuery('#song').val(id);jQuery('#searchPlaylistsSpinner').show();var url=base+extrabase+'/index.php?option=com_muscol&task=searchPlaylists';jQuery.ajax({url:url,dataType:'json',success:function(result){var source=jQuery("#playlistSuggestionsTemplate").html();var template=Handlebars.compile(source);for(var i=0;i<result.length;i++){var html=template(result[i]);jQuery('#playlistsResultContainer').append(html);}
jQuery('#searchPlaylistsSpinner').hide();}});}
function newPlaylistWithSong(id){jQuery('#newPlaylistModal').modal();jQuery('#newPlaylistModal #song').val(id);}
function savePlaylistWithSong(){var title=jQuery('#newPlaylistModal #title').val();var description=jQuery('#newPlaylistModal #description').val();var song=jQuery('#newPlaylistModal #song').val();var url=base+extrabase+'/index.php?option=com_muscol&task=new_playlist_ajax'+
'&title='+title+'&description='+description+'&song='+song;jQuery.ajax({url:url,dataType:'json',success:function(result){notifyMessages(result.notifications);lastPlaylists=result.lastPlaylists;jQuery('#newPlaylistModal').modal('hide');if(typeof(allow_search_album)!=='undefined'){jQuery("#song_search_results").empty();jQuery('div#loadmoreajaxloader_song').show();start_song=0;more_items_song=true;isloading_song=true;reset_playlist();if(typeof(allow_search_album)==='undefined')load_more_items('song',false);else{if(!allow_search_album&&allow_search_song&&!allow_search_artist)load_more_items('song',false);else load_more_items('song');}}}});}
function addSongToOtherPlaylist(playlist_id){var song_id=jQuery('#song').val();add_song_to_playlist(song_id,playlist_id);jQuery('#otherPlaylistsModal').modal('hide');}